# AUTOGENERATED! DO NOT EDIT! File to edit: classfy_image.ipynb (unless otherwise specified).

__all__ = ['search_by_clip', 'get_metadata', 'get_calories', 'cos', 'foods', 'clip', 'search_image']

# Cell
from .tools import *
from .paths import *

import pandas as pd
import numpy as np
from .psql import *

# !nbdev_build_lib
import requests
from .clipmodel import image2clip,text2clip
from PIL import Image
import torch

# Cell
def search_by_clip(clip, topk=5, query_expr='',search_params = {}): #32768
    search_params = {"metric_type": "IP",
                     "params": search_params}

    print(query_expr)
    results = collection.search(clip[None,], "clip", search_params, limit=topk, expr=query_expr, output_fields=["id"])
    results = results[0]
    return list(results.distances), results.ids

def get_metadata(ids):
    q = f"""select * from foods where id in {tuple(ids)}"""
    return pd.read_sql(q,engine)

# Cell
def get_calories(url=None,path=None):
    r = search_image(url=url)
    r = r[(r['energy_kcal_100g']>r['energy_kcal_100g'].quantile(0.3))&(r['energy_kcal_100g']<r['energy_kcal_100g'].quantile(0.9))]
    rr = r[['energy_kcal_100g','proteins_100g','fat_100g','carbohydrates_100g']].mean().round(2)
    rr['ids'] =  r['id'].tolist()
    rr['scores'] =  r['score'].tolist()
    rr['names']  =  r['product_name'].tolist()
    return rr

# Cell
cos = torch.nn.CosineSimilarity(dim=-1, eps=1e-6)
foods = pd.read_sql('select * from foods',engine)
clip = torch.Tensor(foods['clip']).cuda(2).type(torch.float16)

# Cell
def search_image(url=None,path=None,milvus=False):
    if url:
        response = requests.get(url, stream=True)
        image = Image.open(response.raw)
    elif path:
        image = Image.open(path)
    image_clip = image2clip(image)
    if milvus:
        results = search_by_clip(clip.numpy())
        df = get_metadata(results[1])
        df['score'] = results[0]
    else:
        df = foods.drop(columns = ['clip'])
        df['score'] = cos(clip, torch.Tensor(image_clip).cuda(2)).cpu().detach().numpy()
        df = df.sort_values('score',ascending=False).head(1)

    return df